<!doctype html public "-//w3c//dtd html 3.2 final//ru">
<HTML>
<HEAD>
<LINK REL="icon" TYPE="image/png" SIZES="32x32" HREF="/favicon-32x32.png">
<LINK REL="icon" TYPE="image/png" SIZES="16x16" HREF="/favicon-16x16.png">
<META NAME="generator" CONTENT="microsoft visual studio 6.0">
<TITLE>tetris v1.3</TITLE>
<STYLE>
		BODY
		{
			margin:0px;
			padding:0px;
			background:#696 url('bgnd.gif');
			color:#363;
			font-family:arial;
			font-size:10pt;
			overflow:hidden;
		}

		A
		{
			color:#9c9;
			text-decoration:none;
		}

		A:hover
		{
			color:#fc6;
			text-decoration:none;
		}

		A:active
		{
			color:#fc6;
			text-decoration:none;
		}

		A:visited
		{
			color:#9c9;
			text-decoration:none;
		}

		HR
		{
			margin:0px;
			height:1px;
			width:100%;
			color:#9c9;
			text-align:center;
		}

		TABLE
		{
			border:none;
			border-collapse:collapse;
		}

		TH
		{
			color:#363;
			font-size:12pt;
			font-weight:bold;
		}

		TD
		{
			margin:0px;
			padding:0px;
			color:#363;
			font-size:10pt;
			border:none;
			vertical-align:middle;
			text-align:center;
		}

		TABLE.simple
		{
			border:1px solid #9c9;
			border-top-width:10px;
		}

		TABLE.simple TD
		{
			border:1px solid #9c9;
		}

		TABLE.tetris
		{
			border:1px solid #9c9;
			border-top:10px solid #9c9;
			margin:10px;
		}

		TABLE.tetris TD
		{
			border:none;
		}

		TABLE.tetris TD.empty
		{
			background:transparent;
		}

		TABLE.tetris TD.red
		{
			background:red;
		}

		TABLE.tetris TD.orange
		{
			background:orange;
		}

		TABLE.tetris TD.yellow
		{
			background:yellow;
		}

		TABLE.tetris TD.green
		{
			background:green;
		}

		TABLE.tetris TD.aqua
		{
			background:aqua;
		}

		TABLE.tetris TD.blue
		{
			background:blue;
		}

		TABLE.tetris TD.purple
		{
			background:purple;
		}

		TABLE.tetris TD.gray
		{
			background:gray;
		}

		TABLE.tetris TD.brown
		{
			background:brown;
		}

		TABLE.tetris TD.aquamarine
		{
			background:aquamarine;
		}

		TABLE.tetris TD.honeydew
		{
			background:honeydew;
		}

		TABLE.tetris TD.tomato
		{
			background:tomato;
		}

		TABLE.tetris TD.palevioletred
		{
			background:palevioletred;
		}

		TABLE.tetris TD.dimgray
		{
			background:dimgray;
		}

		TABLE.tetris TD.greenyellow
		{
			background:greenyellow;
		}

		TABLE.tetris TD.filled
		{
			background:#363;
		}

		INPUT, SELECT, OPTION
		{
			background:#9c9;
			color:#363;
			border:1px solid #363;
			margin:2px;
			cursor:hand;
			font-family:arial;
			font-size:10pt;
		}

		.menu_passive,.menu_active,.menu_hover
		{
			margin:5px;
			padding:5px;
			border-width:1px;
			border-style:solid;
			text-align:center;
			font-family:arial;
			font-size:12pt;
			font-weight:900;
			cursor:hand;
		}

		.menu_hover
		{
			border-top-color:#9c9;
			border-right-color:#363;
			border-bottom-color:#363;
			border-left-color:#9c9;
			color:#9c9;
		}

		.menu_active
		{
			padding:6px 4px 4px 6px;
			border-top-color:#363;
			border-right-color:#9c9;
			border-bottom-color:#9c9;
			border-left-color:#363;
			color:#fc6;
		}

		.menu_passive
		{
			border-color:#696;
			color:#363;
		}

	</STYLE>
<SCRIPT ASYNC SRC="https://www.googletagmanager.com/gtag/js?id=G-J8N1Q1GVVB"></SCRIPT>
<SCRIPT>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J8N1Q1GVVB');
</SCRIPT>
<SCRIPT TYPE="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105986243', 'ym');
    ym(105986243, 'init', {ssr:true, webvisor:true, clickmap:true, accurateTrackBounce:true, trackLinks:true});
</SCRIPT>
<META NAME="description" CONTENT="Tetris game (v1.3 beta). Legacy JavaScript by Kirill Arkhipenko.">
<META NAME="keywords" CONTENT="Kirill Arkhipenko, Кирилл Архипенко, kusaku, retrewert, aks1983, legacy">
<META NAME="author" CONTENT="Kirill Arkhipenko">
<LINK REL="canonical" HREF="https://kusaku.su/legacy/javascript/projects/tetris/tetris_v1.3_beta.html">
<LINK REL="alternate" HREFLANG="en" HREF="https://kusaku.su/legacy/javascript/projects/tetris/tetris_v1.3_beta.html">
<LINK REL="alternate" HREFLANG="ru" HREF="https://kusaku.su/legacy/javascript/projects/tetris/tetris_v1.3_beta.html">
<META NAME="robots" CONTENT="index, follow">
<META PROPERTY="og:title" CONTENT="tetris v1.3">
<META PROPERTY="og:description" CONTENT="Tetris game (v1.3 beta). Legacy JavaScript by Kirill Arkhipenko.">
<META PROPERTY="og:url" CONTENT="https://kusaku.su/legacy/javascript/projects/tetris/tetris_v1.3_beta.html">
<META PROPERTY="og:type" CONTENT="website">
<META PROPERTY="og:site_name" CONTENT="kusaku.su">
<META PROPERTY="og:image" CONTENT="https://kusaku.su/avatar.webp">
<META NAME="twitter:card" CONTENT="summary">
<META NAME="twitter:title" CONTENT="tetris v1.3">
<META NAME="twitter:description" CONTENT="Tetris game (v1.3 beta). Legacy JavaScript by Kirill Arkhipenko.">
<META NAME="twitter:image" CONTENT="https://kusaku.su/avatar.webp">
</HEAD>

<SCRIPT LANGUAGE=javascript>
	<!--
    /*(c) kusaku 2001 */

    var tetrisrows = 20;
    var tetriscolumns = 10;
    var cellhi = 16;
    var cellwi = cellhi;
    var totalscores = 0;
    var firstplay = true;
    var tetris;
    var shapes;
    var shtraff = -50;
    var top10 = new Array(10);


    var shapesForTetris = new Array(
        new Array(new Array(1,1,1),
                  new Array(0,0,1)),
        new Array(new Array(2,2,2),
                  new Array(0,2,0)),
        new Array(new Array(3,3,3),
                  new Array(3,0,0)),
        new Array(new Array(4,4,0),
                  new Array(0,4,4)),
        new Array(new Array(0,5,5),
                  new Array(5,5,0)),
        new Array(new Array(6,6),
                  new Array(6,6)),
        new Array(new Array(7,7,7,7)));

    var shapesForPentix = new Array(
        new Array(new Array(1,1,1,1,1)),
        new Array(new Array(2,2,2,2),
                  new Array(0,0,0,2)),
        new Array(new Array(3,3,3,3),
                  new Array(0,0,3,0)),
        new Array(new Array(4,4,4,4),
                  new Array(0,4,0,0)),
        new Array(new Array(5,5,5,5),
                  new Array(5,0,0,0)),
        new Array(new Array(6,6,6),
                  new Array(0,6,6)),
        new Array(new Array(7,7,7),
                  new Array(7,7,0)),
        new Array(new Array(8,8,8),
                  new Array(8,0,8)),
        new Array(new Array(9,9,9),
                  new Array(0,0,9),
                  new Array(0,0,9)),
        new Array(new Array(10,10,0),
                  new Array(0,10,10),
                  new Array(0,0,10)),
        new Array(new Array(11,11,11),
                  new Array(0,11,0),
                  new Array(0,11,0)),
        new Array(new Array(0,12,0),
                  new Array(12,12,12),
                  new Array(0,12,0)),
        new Array(new Array(0,13,0),
                  new Array(13,13,13),
                  new Array(0,0,13)),
        new Array(new Array(0,14,0),
                  new Array(14,14,14),
                  new Array(14,0,0)))


    function Game(rows, columns, gamename, playername, scores, field, fieldNext, scorefield, speed, level, allownext)
    {
        this.EMPTY = 0;
        this.FILLED = 16;
        this.rows = rows;
        this.columns = columns;
        this.gamename = gamename;
        this.playername = playername;
        this.scores = scores;
        this.speed = speed;
        this.level = level;
        this.allownext = allownext;
        this.active = true;
        this.field = field;
        this.fieldNext = fieldNext;
        this.scorefield = scorefield;
        this.getField = GetField;
        this.getCells = GetCells;
        this.getShape = GetShape;
        this.addElements = AddElements;
        this.checkLines = CheckLines;
        this.deleteLine = DeleteLine;
        this.driver = Driver;
        this.shapeFall = new Function("with(this.shape){if(notIntersect(x,y+1,rows,columns,elements)&&status!=INACTIVE){y++;this.painter.reDraw(false);}else sticked=true;}");
        this.destroy = Destroy;
        this.cell = this.getField(this.level);
        this.speeds = new Array(1000, 902, 810, 722, 640, 562, 490, 422, 360, 302, 250, 202, 160, 122, 90, 62, 40, 22, 10);
        this.changeSpeed = new Function("speed", "clearInterval(this.TSFall);this.TSFall=setInterval(this.gamename+\".shapeFall()\",this.speeds[this.speed]);");
        this.logic = Logic;
        this.shape = this.getShape();
        this.next = this.getShape();
        this.shape.status = this.shape.FREEFALL
        this.painter = new Drawer(this);
        this.painter.reDraw(true);
        this.TSDriver = setInterval(this.gamename + ".driver(" + this.gamename + ".shape)", 1);
        this.TSFall = setInterval(this.gamename + ".shapeFall()", this.speeds[this.speed]);
        this.TLogic = setInterval(this.gamename + ".logic()", 10);
    }

    function Driver(that)
    {
        with (that) if (!sticked) switch (status)
        {
            case FREEFALL:
                //??
                //game.painter.reDraw(false);
            break;

            case DROP:
                if (notIntersect(x, y + 1, rows, columns, elements)) y++;
                else sticked = true;
                status = FREEFALL;
                this.painter.reDraw(false);
            break;

            case CHANGESHAPE:
                if (this.scores >= shtraff * (1 + this.allownext))
                {
                    var addScores = shtraff * (1 + this.allownext);
                    this.scores -= addScores;
                    this.scorefield.innerHTML = this.scores + "(-" + addScores + ")";
                    this.shape = this.next;
                    if (this.shape.notIntersect(this.shape.x, this.shape.y, this.shape.rows, this.shape.columns, this.shape.elements))
                    {
                        this.shape.status = this.shape.FREEFALL;
                        this.next = this.getShape();
                        this.painter.reDraw(true);
                    }
                    else this.destroy();
                }
                status = FREEFALL;
            break;

            case MOVELEFT:
                if (notIntersect(x - 1, y, rows, columns, elements)) x--;
                status = FREEFALL;
                this.painter.reDraw(false);
            break;

            case MOVERIGHT:
                if (notIntersect(x + 1, y, rows, columns, elements)) x++;
                status = FREEFALL;
                this.painter.reDraw(false);
            break;

            case ROTATELEFT:
                if (rotate(false)) this.painter.reDraw(false);
                status = FREEFALL;
            break;

            case ROTATERIGHT:
                if (rotate(true)) this.painter.reDraw(false);
                status = FREEFALL;
            break;

            case INACTIVE:
                ///status =  "awaiting for game";
            break;
        }
    }

    function Destroy()
    {

        clearInterval(this.TSDriver);
        clearInterval(this.TSFall);
        clearInterval(this.TLogic);

        for (i=0; i!=this.rows; i++)
            for (k=0; k!=this.columns; k++)
                if (this.cell[i][k] != this.EMPTY) this.cell[i][k] = this.FILLED;

        this.painter.reDraw(false);

        for (i=0; i!=5; i++)
            for (k=0; k!=5; k++)
                this.painter.fillCell(this.fieldNext, i, k, this.painter.styles[0]);

        this.shape.status = this.shape.INACTIVE;

        this.active = false;

        saveData(this.playername, this.scores);
        displayTop10();
    }

    function GetField(level)
    {
        var rowsToFill = Math.round(this.rows * level / 12);

        cells = new Array(this.rows);
        for (i=0; i!=this.rows - rowsToFill; i++)
        {
            cells[i] = new Array(this.columns);
            for (k=0; k!=this.columns; k++) cells[i][k] = this.EMPTY;
        }
        for (i=this.rows - rowsToFill; i!=this.rows; i++)
        {
            cells[i] = new Array(this.columns);
            for (k=0; k!=this.columns; k++)
                if (Math.random() > .45) cells[i][k] = this.EMPTY;
                else cells[i][k] = Math.round(Math.random() * 14) + 1;
        }
        return cells;
    }

    function GetCells()
    {
        var cells = new Array(this.rows);
        for (i=0; i!=this.rows; i++)
        {
            cells[i] = new Array(this.columns);
            for (k=0; k!=this.columns; k++) cells[i][k] = this.cell[i][k];
        }
        return cells;
    }

    function GetShape()
    {
        var number = Math.floor(shapes.length * Math.random());
        var elements = shapes[number];
        var corx = Math.floor(elements[0].length/2);
        var cory = Math.floor(elements.length/2);
        var x = Math.round(this.columns / 2 - corx);
        var y = Math.max(elements[0].length, elements.length) - corx;

        shape = new Shape(x, y, elements, elements.length, elements[0].length, corx, cory, this);

        var number = Math.round(4 * Math.random());
        with (shape) for (n=0; n<number; n++) // random rotation
            {
                stencil = new Array(columns); //rows
                for (i=0; i!=columns; i++)
                {
                    stencil[i] = new Array(rows); //columns
                    for (k=0; k!=rows; k++)
                    stencil[i][k] = elements[rows - k - 1][i];
                }
                if (notIntersect(x + corx + cory - rows, y + cory - corx, columns, rows, stencil))
                {
                    x += corx + cory - rows;
                    y += cory - corx;
                    var a = cory;
                    cory = corx;
                    corx = rows - a;
                    rows^=columns;
                    columns^=rows;
                    rows^=columns;
                    elements = stencil;
                }
            }
        return shape;
    }

    function Logic()
    {
        if (this.shape.sticked)
        {
            var addScores = this.shape.getNumOfNbh(this.shape.x, this.shape.y) - this.shape.getNumOfMpt(this.shape.x, this.shape.y);
            this.addElements(this.shape)
            var multScores = this.checkLines(this.shape);
            addScores *= (multScores==0) ? 1 : multScores + 1;
            this.scores += addScores;
            this.scorefield.innerHTML = this.scores + "(+" + addScores + ")";
            if (this.scores / 100 - 1 > this.speed) this.changeSpeed(this.speed++);

            this.shape = this.next;
            if (this.shape.notIntersect(this.shape.x, this.shape.y, this.shape.rows, this.shape.columns, this.shape.elements))
            {
                this.shape.status = this.shape.FREEFALL;
                this.next = this.getShape();
                this.painter.reDraw(true);
                bestPosition(tetris, tetris.shape);
            }
            else this.destroy();
            CollectGarbage();
        }
    }

    function AddElements(shape)
    {
        for (i=0; i!=shape.rows; i++)
            for (k=0; k!=shape.columns; k++)
                if (shape.elements[i][k] != shape.EMPTY)
                    this.cell[shape.y + i][shape.x + k] = shape.elements[i][k];
    }

    function CheckLines(that)
    {
        var lines = 0;
        for (i=that.y; i!=that.y + that.rows; i++)
        {
            var haveFullLine = true;
            for (k=0; k!=this.columns; k++) haveFullLine = haveFullLine && (this.cell[i][k] != this.EMPTY);
            if (haveFullLine)
            {
                lines++;
                this.deleteLine(i);
                i--;
            }
        }
        return lines;
    }

    function DeleteLine(number)
    {
        for (i=number; i!=1; i--)
            for (k=0; k!=this.columns; k++)
                this.cell[i][k] = this.cell[i - 1][k];
    }

    function Shape(x, y, elements, rows, columns, corx, cory, game)
    {
        this.ROTATELEFT = 0;
        this.ROTATERIGHT = 1;
        this.CHANGESHAPE = 5;
        this.MOVERIGHT = 2;
        this.MOVELEFT = 3;
        this.DROP = 4;
        this.FREEFALL = -1;
        this.INACTIVE = -2;
        this.EMPTY = 0;
        this.status = this.INACTIVE;
        this.sticked = false;
        this.game = game;
        this.elements = elements;
        this.rows = rows;
        this.columns = columns;
        this.x = x;
        this.y = y;
        this.corx = corx;
        this.cory = cory;
        this.notIntersect = NotIntersect;
        this.getNumOfNbh = GetNumOfNbh;
        this.getNumOfMpt = GetNumOfMpt;
        this.rotate = Rotate;
    }

    function Rotate(clockwise)
    {
        var rotated = false;

        with (this) if (clockwise)
        {
                stencil = new Array(columns); //rows
                for (i=0; i!=columns; i++)
                {
                    stencil[i] = new Array(rows); //columns
                    for (k=0; k!=rows; k++)
                    stencil[i][k] = elements[rows - k - 1][i];
                }
                if (notIntersect(x + corx + cory - rows, y + cory - corx, columns, rows, stencil))
                {
                    x += corx + cory - rows;
                    y += cory - corx;
                    var a = cory;
                    cory = corx;
                    corx = rows - a;
                    rows^=columns;
                    columns^=rows;
                    rows^=columns;
                    elements = stencil;
                    rotated = true;
                }
        }
        else
        {
                stencil = new Array(columns); //rows
                for (i=0; i!=columns; i++)
                {
                    stencil[i] = new Array(rows); //columns
                    for (k=0; k!=rows; k++)
                    stencil[i][k] = elements[k][columns - i - 1];
                }
                if (notIntersect(x + corx - cory, y + cory + corx - columns, columns, rows, stencil))
                {
                    x += corx - cory;
                    y += cory + corx - columns;
                    var a = corx;
                    corx = cory;
                    cory = columns - a;
                    rows^=columns;
                    columns^=rows;
                    rows^=columns;
                    elements = stencil;
                    rotated = true;
                }
        }

        return rotated;
    }


    function NotIntersect(x, y, rows, columns, stencil)
    {
        if (x < 0 || x + columns > this.game.columns || y + rows > this.game.rows || y < 0) return false;
        var answer = true;
        for (i=0; (i!=rows && answer); i++)
            for (k=0; k!=columns; k++)
                answer = answer && !(this.game.cell[y + i][x + k] != this.game.EMPTY && stencil[i][k] != this.EMPTY);


    /*
        {

            s1 = new String();

            for (i=-2; i!=this.rows + 2; i++)
                {
                s1 += y + i;
                    for (k=-2; k!=this.columns + 2; k++)
                    {
                        {
                        //status = (y + i) + ":" + (x + k);
                        if (y + i > -1 && y + i < this.game.rows && x + k > -1 && x + k < this.game.columns)
                        {

                        if (i > -1 && i < this.rows && k > -1 && k < this.columns)
                         s1 += ":" + (this.game.cell[y + i][x + k] + this.elements[i][k]) + ":";
                        else s1 += ":" + this.game.cell[y + i][x + k] + ":";
                        }
                        }
                    }
                    s1 += "\n";
                }

            var oldx = this.x;
            var oldy = this.y;
            this.x = x;
            this.y = y;
            this.game.painter.reDraw(true);
            this.x = oldx;
            this.y = oldy;
            s1 = "look!(in notint)\n" + s1 + "\nx:" + x + " y:" + y + "\nso that is notint: " + answer + "\n\n";
        }
    */
        return answer;
    }

    function GetNumOfNbh(x, y, recurs)
    {
        if (x == null) x = this.x;
        if (y == null) y = this.y;
        var numofnbh = 0;
        for (i=0; i!=this.rows; i++)
            for (k=0; k!=this.columns; k++)
                if (this.elements[i][k] != this.EMPTY)
                {

                    if (y + i == 0) numofnbh++;
                    else if (this.game.cell[y + i - 1][x + k] != this.game.EMPTY) numofnbh++;
                    if (y + i == this.game.rows - 1) numofnbh++;
                    else if (this.game.cell[y + i + 1][x + k] != this.game.EMPTY) numofnbh++;
                    if (x + k == 0) numofnbh++;
                    else if (this.game.cell[y + i][x + k - 1] != this.game.EMPTY) numofnbh++;
                    if (x + k == this.game.columns - 1) numofnbh++;
                    else if (this.game.cell[y + i][x + k + 1] != this.game.EMPTY) numofnbh++;
                }
    /*
        if (!recurs) if (numofnbh == 0)
        {
            var a = this.getNumOfNbh(x,y, true)
            var s= new String();
            for (i=0; i!=this.rows; i++)
                {
                    for (k=0; k!=this.columns; k++)
                        s += ":" + this.elements[i][k] + ":";
                    s += "\n";
                }
            for (i=-2; i!=this.rows + 2; i++)
                {
                s += y + i;
                    for (k=-2; k!=this.columns + 2; k++)
                    {
                        {
                        //status = (y + i) + ":" + (x + k);
                        if (y + i > -1 && y + i < this.game.rows && x + k > -1 && x + k < this.game.columns)
                        {

                        if (i > -1 && i < this.rows && k > -1 && k < this.columns)
                         s += ":" + (this.game.cell[y + i][x + k] + this.elements[i][k]) + ":";
                        else s += ":" + this.game.cell[y + i][x + k] + ":";
                        }
                        }
                    }
                    s += "\n";
                }

            var oldx = this.x;
            var oldy = this.y;
            this.x = x;
            this.y = y;
            this.game.painter.reDraw(true);
            this.x = oldx;
            this.y = oldy;
            alert(s1 + "look!\n" + s + "nbh was:" + numofnbh + " now:" + a + "\nx:" + x + " y:" + y);
        }
    */

        //if (numofnbh != this.getNumOfNbh(x,y)) numofnbh = this.getNumOfNbh(x,y);
        return numofnbh;


    }

    function GetNumOfMpt(x, y)
    {
        if (x == null) x = this.x;
        if (y == null) y = this.y;
        var numofmpt = 0;
        for (i=0; i!=this.rows; i++)
            for (k=0; k!=this.columns; k++)
            if (this.elements[i][k] != this.EMPTY && y + i + 1 != this.game.rows)
                if (i == this.rows - 1)
                    if (this.game.cell[y + i + 1][x + k] == this.game.EMPTY) numofmpt++; else;
                else
                    if (this.elements[i + 1][k] == this.EMPTY && this.game.cell[y + i + 1][x + k] == this.game.EMPTY) numofmpt++;
        return numofmpt;
    }

    function Drawer(game)
    {
        this.game = game;
        this.olddata = this.game.getCells();
        this.newdata;
        this.reDraw = ReDraw;
        this.fillCell = new Function("target", "row", "column", "cname", "target.rows[row].cells[column].className = cname;");
        this.styles = new Array("empty", "red", "orange", "yellow", "green", "aqua", "blue", "purple", "gray", "brown", "aquamarine", "honeydew", "tomato", "palevioletred", "dimgray", "greenyellow", "filled");
    }

    function ReDraw(all)
    {
        this.newdata = this.game.getCells();

        if (this.game.shape.status != this.game.shape.INACTIVE)
        for (i=0; i!=this.game.shape.rows; i++)
            for (k=0; k!=this.game.shape.columns; k++)
                if (this.game.shape.elements[i][k] != this.game.EMPTY) this.newdata[this.game.shape.y + i][this.game.shape.x + k] = this.game.shape.elements[i][k];

        if (all)
        {
            for (i=0; i!=this.game.rows; i++)
                for (k=0; k!=this.game.columns; k++)
                    this.fillCell(this.game.field, i, k, this.styles[this.newdata[i][k]]);

            if (this.game.allownext)
            {
                var xPos = Math.floor(2.5 - this.game.next.columns/2);
                var yPos = Math.floor(2.5 - this.game.next.rows/2);
                for (i=0; i!=5; i++)
                    for (k=0; k!=5; k++)
                        this.fillCell(this.game.fieldNext, i, k, this.styles[0]);
                with (this.game.next)
                    for (i=0; i!=rows; i++)
                        for (k=0; k!=columns; k++)
                            this.fillCell(this.game.fieldNext, i + yPos, k + xPos, this.styles[elements[i][k]]);
            }
        }
        else
        for (i=0; i!=this.game.rows; i++)
            for (k=0; k!=this.game.columns; k++)
                if (this.newdata[i][k] != this.olddata[i][k] && !all) this.fillCell(this.game.field, i, k, this.styles[this.newdata[i][k]]);

        this.olddata = this.newdata;
    }

    function getFieldHTML(rows, columns, cellh, cellw, style, idName)
    {
        var s;
        s = "<table id=" + idName + " name=" + idName + " class=" + style + ">";
        for (i = 0; i!=rows; i++)
        {
            s+="<tr>";
            for (k = 0; k!=columns; k++) s+="<td style=\"height:" + cellh + "px;width:" + cellw + "px;\"></td>\n";
            s+="</tr>\n"
        }
        s += "</table>";
        return s;
    }

    function KeyHooker(code)
    {
        if (tetris) with (tetris.shape) switch (code)
        {
            case 38 : status = CHANGESHAPE;
            break;
            case 37 : status = MOVELEFT;
            break;
            case 90 : status = ROTATELEFT;
            break;
            case 88 : status = ROTATERIGHT;
            break;
            case 39 : status = MOVERIGHT;
            break;
            case 40 : status = DROP;
            break;
            case 32 :
                //bestPosition(tetris, tetris.shape);
                alert("Для продолжения нажмите");
            break;
        }
    }

    function setCookie(name, value, savefor, path, domain, secure)
    {
        var expires = null;
        if (savefor)
        {
            now = new Date();
            now.setTime(Date.parse(now) + savefor*24*60*60*1000);
            expires = now.toGMTString();
        }

        var curCookie = name + "=" + escape(value) +
            ((expires) ? "; expires=" + expires : "") +
            ((path) ? "; path=" + path : "") +
            ((domain) ? "; domain=" + domain : "") +
            ((secure) ? "; secure" : "");
            document.cookie = curCookie;
    }

    function getCookie(name)
    {
        var prefix = name + "="
        var cookieStartIndex = document.cookie.indexOf(prefix)
        if (cookieStartIndex == -1)
            return false
        var cookieEndIndex = document.cookie.indexOf(";", cookieStartIndex + prefix.length)
        if (cookieEndIndex == -1)
            cookieEndIndex = document.cookie.length
        return unescape(document.cookie.substring(cookieStartIndex + prefix.length, cookieEndIndex));
    }

    function saveData(name, score)
    {
        for (i=0; i != 10 && top10[i] && score < top10[i][1]; i++);
        for (k=9; k != i - 1; k--) top10[k] = top10[k - 1];

        top10[i] = new Array(name, score);

        for (i=0; i != 10 && top10[i]; i++)
        {
            setCookie(i + "n", top10[i][0], 365);
            setCookie(i + "s", top10[i][1], 365);
        }
    }

    function bestPosition(game, shape)
    {
        var oldx = shape.x;
        var oldy = shape.y;
        var bestx;
        var besty;
        var bestrot;
        var usefulness;
        var mostusefull = -100000;
        actions = new Array();

        for (rot=0; rot!=4; rot++)
        {
        var maxxpos = game.columns - shape.columns + 1;
            for (xpos=0; xpos!=maxxpos; xpos++)
            {
                var ypos = oldy;
                while (shape.notIntersect(xpos, ypos, shape.rows, shape.columns, shape.elements)) ypos++;
                ypos--;
                usefulness = (ypos*ypos) * (shape.getNumOfNbh(xpos, ypos) - shape.getNumOfMpt(xpos, ypos));
                if (mostusefull < usefulness && ypos > oldy)
                {
                    mostusefull = usefulness;
                    bestx = xpos;
                    besty = ypos;
                    bestrot = rot;
                }
            }
        shape.rotate(true)
        }


        var rotdir = (bestrot == 3) ? shape.ROTATELEFT : shape.ROTATERIGHT;

        if (bestrot == 1) bestx += shape.rows - shape.corx - shape.cory;
        if (bestrot == 2) bestx += shape.columns - 2 * shape.corx;
        if (bestrot == 3) bestx += shape.cory - shape.corx;

        bestrot = Math.min(4 - bestrot, bestrot);

        for (rot=0; rot!=bestrot; rot++) actions[rot] = rotdir;
        for (i=bestrot; i!=bestrot + Math.abs(oldx - bestx); i++) actions[i] = (oldx > bestx) ? shape.MOVELEFT : shape.MOVERIGHT;
        for (i=bestrot + Math.abs(oldx - bestx); i!=100; i++) actions[i] = shape.DROP;

        //setTimeout("Manipulator(actions, 0);",500);
        clearTimeout(TAct)
        Manipulator(actions, 0)
    }

    var actions;
    var TAct;

    function Manipulator(actions, number)
    {
        var ms = (actions[number] == tetris.shape.DROP) ? 10 : 100;
        if (number < actions.length)
            TAct = setTimeout("tetris.shape.status = actions[" + number + "]; Manipulator(actions, " + (number + 1) + ");",ms);
    }

    function displayTop10()
    {
        var s = new String()

        s = "<table class=simple>";
        s += "<tr><th colSpan=3>лидеры</th></tr>";
        s += "<tr><th>#</th><th>имя</th><th>очки</th></tr>";

        for (i=0; top10[i] && i < 10; i++)
            s += "<tr><td>" + (i + 1) + "</td><td>" + top10[i][0] + "</td><td>" + top10[i][1] + "</td></tr>";

        s += "<tr><td colSpan=3>&lt;щелкните чтобы убрать&gt;</td></tr>";
        s += "</table>";

        topten.innerHTML = s;
        topten.style.visibility = "visible";
    }


    function getData()
    {
        for (i=0; getCookie(i + "n") && getCookie(i + "s") && i < 10; i++)
            top10[i] = new Array(getCookie(i + "n"), parseInt(getCookie(i + "s")));
    }

    function Init()
    {
        if (!firstplay)
        {
            if (tetris.active) tetris.destroy();
            tetris.painter.reDraw(false);
        }
        else firstplay = false;

        var speed = document.optform.playerSpeed[document.optform.playerSpeed.selectedIndex].value;
        var level = document.optform.playerLevel[document.optform.playerLevel.selectedIndex].value;
        var allownext = document.optform.playerAllowNext.checked;
        var playername = document.optform.playerName.value;

        var da = new Date()
        playername = da.toLocaleString();
        status = playername;
        if (document.optform.tetris.checked) shapes = shapesForTetris;
        if (document.optform.pentix.checked) shapes = shapesForPentix;

        tetris = new Game(tetrisrows, tetriscolumns, "tetris", playername, totalscores, tetrisfield, tetrisfieldnext, scoreboard, speed, level, allownext);
        setTimeout("bestPosition(tetris, tetris.shape);",100);

    }

    //-->
</SCRIPT>

<BODY>

<TABLE STYLE="width:100%;height:100%">
	<TR><TD>

		<TABLE CLASS=simple>
			<TR>
				<TD STYLE="text-align:center;">
					<DIV ID=scoreboard STYLE="margin:10px;background:#696;border:#9c9 1px solid;border-top:#9c9 10px solid;font-family:arial;font-size:15pt;font-weight:900;text-align:center;width:100%">
						0(+0)
					</DIV>
				</TD>
				<TD ROWSPAN="2">
					tetris v1.3
					<HR>
					<FORM ID=optform NAME=optform>
						<TABLE CLASS=simple STYLE="margin:10px;background:#696;">
							<TR>
								<TD>Имя игрока:</TD>
								<TD>
									<INPUT TYPE="text" SIZE=20 MAXLENGTH=20 VALUE=anonimous NAME=playerName STYLE="width:80%">
								</TD>
							</TR>
							<TR>
								<TD>Играть в:</TD>
								<TD>
									<INPUT TYPE="radio" NAME=gametype ID=tetris CHECKED> тетрис
									<INPUT TYPE="radio" NAME=gametype ID=pentix> пентикс.
								</TD>
							</TR>
							<TR>
								<TD>Скорость:</TD>
								<TD>
									<SELECT NAME=playerSpeed STYLE="width:80%">
										<OPTION VALUE="0">медлительно</OPTION>неторопливо   скоро
										<OPTION VALUE="1">тихо</OPTION>
										<OPTION VALUE="2" SELECTED>нормально</OPTION>
										<OPTION VALUE="3">ходко</OPTION>
										<OPTION VALUE="4">проворно</OPTION>
										<OPTION VALUE="5">бойко</OPTION>
										<OPTION VALUE="6">резво</OPTION>
										<OPTION VALUE="7">прытко</OPTION>
										<OPTION VALUE="8">шибко</OPTION>
										<OPTION VALUE="9">стремительно</OPTION>
									</SELECT>
								</TD>
							</TR>
							<TR>
								<TD>Уровень:</TD>
								<TD>
									<SELECT NAME=playerLevel STYLE="width:80%">
										<OPTION VALUE="0" SELECTED>тривиально</OPTION>
										<OPTION VALUE="1">пустяково</OPTION>
										<OPTION VALUE="2">легко</OPTION>
										<OPTION VALUE="3">нетрудно</OPTION>
										<OPTION VALUE="4">нормально</OPTION>
										<OPTION VALUE="5">посильно</OPTION>
										<OPTION VALUE="6">с хитрецой</OPTION>
										<OPTION VALUE="7">непросто</OPTION>
										<OPTION VALUE="8">замысловато</OPTION>
										<OPTION VALUE="9">головоломно</OPTION>
									</SELECT>
								</TD>
							</TR>
							<TR>
								<TD COLSPAN=2><CENTER>Показывать следующюю фигуру <INPUT TYPE="checkbox" NAME=playerAllowNext></CENTER></TD>
							</TR>
						</TABLE>
					</FORM>
					<HR>
					<DIV CLASS="menu_passive"
						 ONMOUSEOVER="this.className='menu_hover'"
						 ONMOUSEOUT="this.className='menu_passive'"
						 ONMOUSEUP="this.className='menu_hover'"
						 ONCLICK="Init();"
						 ONMOUSEDOWN="this.className='menu_active'">
						НАЧАТЬ
					</DIV>
					<DIV CLASS="menu_passive"
						 ONMOUSEOVER="this.className='menu_hover'"
						 ONMOUSEOUT="this.className='menu_passive'"
						 ONMOUSEUP="this.className='menu_hover'"
						 ONCLICK="displayTop10();"
						 ONMOUSEDOWN="this.className='menu_active'">
						ПОКАЗАТЬ ЛИДЕРОВ
					</DIV>
					<HR>
					<DIV ID=tetrisnextboard></DIV>
				</TD>
			</TR>
			<TR>
				<TD>
					<DIV ID=tetrisboard></DIV>
				</TD>
			</TR>
			<TR>
				<TD>
					<DIV STYLE="COLOR: #363; FONT-SIZE: 7pt; MARGIN: 0px; PADDING-BOTTOM: 5px; PADDING-LEFT: 5px; PADDING-RIGHT: 5px; PADDING-TOP: 5px">
						(c) <A HREF="mailto:me@kusaku.su?subject=webmaster">kusaku</A> 2001
						<BR>
						No rights reserved.
						<BR>
						Freeware: use this software on your own risk.
						<BR>
						This game is a part of <A HREF="http://www.physfac.nm.ru/">Physfac@RU</A> site.
						<BR>
					</DIV>
				</TD>
				<TD>
					<DIV STYLE="COLOR: #9c9; FONT-SIZE: 7pt; MARGIN: 0px; PADDING-BOTTOM: 5px; PADDING-LEFT: 5px; PADDING-RIGHT: 5px; PADDING-TOP: 5px;">
						Управление:
						<BR>
						Поворот Z - против / X - по часовой стрелке
						<BR>
						Движение &rarr; - вправо / &larr; - влево / &darr; - бросить,
						<BR>
						Выбрать следующюю фигуру с уменьшением очков - &uarr;.
					</DIV>
				</TD>
			</TR>
		</TABLE>

	</TD></TR>
</TABLE>

<DIV ID=topten ONCLICK="this.style.visibility='hidden'" STYLE="position:absolute;background:#696;top:10px;left:10px;cursor:hand;visibility:hidden;">
</DIV>

<SCRIPT LANGUAGE=javascript>
	<!--
        tetrisboard.innerHTML = getFieldHTML(tetrisrows, tetriscolumns, cellhi, cellwi, "tetris", "tetrisfield");
        tetrisnextboard.innerHTML = getFieldHTML(5, 5, cellhi, cellwi, "tetris", "tetrisfieldnext");
        document.onkeydown = new Function("KeyHooker(event.keyCode)");
        window.onload = getData;
    //-->
</SCRIPT>
</BODY>
</HTML>
